!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("jQuery")):"function"==typeof define&&define.amd?define(["jQuery"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).jQuery)}(this,function(e){"use strict";const t={merge:$.extend,each:Object.prototype.forEach,has:Object.prototype.hasOwnProperty,slice:Array.prototype.slice,isObj:e=>$.isPlainObject(e),isArr:e=>$.isArray(e),isFunc:e=>!!(e&&e.constructor&&e.call&&e.apply),isStr:e=>"string"==typeof e,isType:(e,t,r)=>{if(typeof t!==e)return`Error :: ${r} must be of type ${e}`},hasArgs:(e,t=1)=>{const r=e.toString().match(/\(([^)]*)\)/);return(r&&r[1].match(/[^\s,]+/g)||[]).length>=t},inject:(e,r)=>{var n;for(n in r)t.hasProp.call(r,n)&&(e[n]=r[n]);function s(){this.constructor=e}return s.prototype=r.prototype,e.prototype=new s,e.__super__=r.prototype,e},isRetina:()=>window.retina||window.devicePixelRatio>1,isMobile:e=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e),getObjectSize:e=>{var t,r=0;for(t in e)e.hasOwnProperty(t)&&(r+=1);return r},getPxValue:(e,t)=>{var r;switch(t){case"em":r=this.convertToEm(e);break;case"pt":r=this.convertToPt(e);break;default:r=e}return r},rand:(e,t)=>Math.floor(Math.random()*(t-e+1))+e,args:e=>{var r;return((null!==e&&null!==(r=e.toString().match(t.fnRgx))?r[1]:void 0)||"").match(t.argRgx)||[]},resize:e=>{e.height||(e=$(e)),$(()=>{$(window).resize(()=>{e.height($(window).height())}),$(window).resize()})},slugify:e=>e.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,""),clone:e=>{var t,r,n;if(e instanceof Array)t=(()=>{var t,r,s;for(s=[],t=0,r=e.length;t<r;t++)n=e[t],s.push(n);return s})();else for(r in t={},e)n=e[r],t[r]=n;return t},convertToEm:e=>e*this.getFontsize(),convertToPt:e=>{},convertBase:()=>{var e=document.createElement(),t=e.getAttribute("style");return e.setAttribute("style",t+";font-size:1em !important"),e.setAttribute("style",t),base=this.getFontsize(),base},mix:(e,t,r)=>{var n,s,o;if(!0===r){for(n in s=[],e)o=e[n],s.push(t[n]=o);return s}for(n in e)o=e[n],t.hasOwnProperty(n)||s.push(t[n]=o);return s},mixin:function(e,t,r){switch(r&&null!==r||(r=!1),typeof t+"-"+typeof e){case" - ":return this.mix(t.prototype,e.prototype,r);case" -object":return this.mix(t.prototype,e,r);case"object-object":return this.mix(t,e,r);case"object- ":return this.mix(t,e.prototype,r)}},unique:e=>{var t="";for(e&&null!==e||(e=8);t.length<e;)t+=Math.random().toString(36).substr(2);return t.substr(0,e)},run:{series:(e=[])=>e.length?e.reduce((e,t,r)=>e.then(e=>Promise.resolve(t()).then(t=>[...e,t]).catch(e=>{const t=new Error(`Task ${r} failed`);throw t.originalError=e,t})),Promise.resolve([])):Promise.resolve([]),parallel:(e=[])=>e.length?Promise.all(e.map(e=>Promise.resolve(e()))):Promise.resolve([]),first:(e=[])=>e.length?e[0]().catch(()=>{if(e.length>1)return t.run.first(e.slice(1));throw new Error("All tasks failed")}):Promise.resolve(null)}},r=function(e={}){const n=this;return this.channels={},this.cascade=e.cascade||!1,this.fireOrigin=e.fireOrigin||!1,this.debug=e.debug||!1,this._delete=(e,r,n)=>{if(!this.channels[e])return[];const s=this.channels[e].length;this.channels[e]=this.channels[e].filter(e=>(!r||e.callback!==r)&&((!n||e.context!==n)&&!(!r&&!n&&e.context===this)));const o=s-this.channels[e].length;return o>0&&t.log(`Removed ${o} subscription(s) from '${e}'`),this.channels[e]},this._setupTasks=(e,r,n)=>(this.channels[r]||[]).map(r=>()=>new Promise((s,o)=>{if(t.hasArgs(r.callback,3))r.callback.call(r.context,e,n,(e,t)=>{e?o(e):s(t)});else{const t=r.callback.call(r.context,e,n);t&&"function"==typeof t.then?t.then(s).catch(o):s(t)}}).catch(e=>Promise.reject(e))),this._formatErrors=e=>{if(t.isArr(e)){const t=e.filter(e=>null!=e).map(e=>e.message||String(e)),r=new Error(t.join("; "));return r.originalErrors=e,r}return e},this.create=()=>new r,this.add=function(e,t,r){if("string"!=typeof e)throw new Error("Channel must be a string");if("function"!=typeof t)throw new Error("Callback must be a function");this.channels[e]||(this.channels[e]=[]);const n={event:e,context:r||this,callback:t};return this.channels[e].push(n),this},this.remove=function(e,t,r){switch(typeof e){case"string":"function"==typeof t?this._delete(e,t,r):void 0===t&&this._delete(e);break;case"function":Object.keys(this.channels).forEach(t=>{this._delete(t,e)});break;case"undefined":this.clear();break;case"object":null!==e&&Object.keys(this.channels).forEach(t=>{this._delete(t,null,e)})}return this},this.once=function(e,t,r){if("string"!=typeof e)throw new Error("Channel must be a string");if("function"!=typeof t)throw new Error("Callback must be a function");let n=!1;const s=(...o)=>{if(!n)return n=!0,this.remove(e,s),t.apply(r||this,o)};return this.add(e,s,r)},this.clear=function(){return Object.keys(this.channels).forEach(e=>delete this.channels[e]),t.log("All channels cleared"),this},this.fire=function(e,r){if("string"!=typeof e)return Promise.reject(new Error("Channel must be a string"));"function"==typeof r&&(r=void 0);const s=n._setupTasks(r,e,e);return 0===s.length?Promise.resolve(null):t.run.first(s).catch(e=>{throw n._formatErrors(e)})},this.emit=function(e,r,s){if("string"!=typeof e)return Promise.reject(new Error("Channel must be a string"));r&&t.isFunc(r)&&(r=void 0),s=s||e;const o=n._setupTasks(r,e,s);return t.run.series(o).then(t=>{if(n.cascade){const o=e.split("/");if(o.length>1){const e=o.slice(0,-1).join("/"),i=n.fireOrigin?s:e;return this.emit(e,r,i).then(()=>t)}}return t}).catch(e=>{throw n._formatErrors(e)})},this.waitFor=function(e,t){return new Promise((r,n)=>{let s;t&&t>0&&(s=setTimeout(()=>{this.remove(e,o),n(new Error(`Timeout waiting for event '${e}' after ${t}ms`))},t));const o=(t,n)=>{s&&clearTimeout(s),this.remove(e,o),r({data:t,origin:n,channel:e})};this.add(e,o)})},this.pipe=function(e,t,r){return t&&(t.fire||t.emit)&&(r=t,t=e),r||(r=this),r===this&&e===t||this.add(e,(...e)=>r.fire(t,...e)),this},this.namespace=function(e){const t=e+"/";return{add:(e,r,n)=>this.add(t+e,r,n),remove:(e,r,n)=>this.remove(t+e,r,n),fire:(e,r)=>this.fire(t+e,r),emit:(e,r,n)=>this.emit(t+e,r,n),once:(e,r,n)=>this.once(t+e,r,n),waitFor:(e,r)=>this.waitFor(t+e,r),pipe:(e,r,n)=>this.pipe(t+e,t+r,n),getSubscriberCount:e=>this.getSubscriberCount(t+e),clear:()=>(Object.keys(this.channels).forEach(e=>{e.startsWith(t)&&delete this.channels[e]}),this)}},this.install=function(e,r=!1){return t.isObj(e)?(Object.keys(this).forEach(t=>{const n=this[t];"function"!=typeof n||!r&&e[t]||(e[t]=n.bind(this))}),this):this},this.getChannels=function(){return Object.keys(this.channels).filter(e=>this.channels[e]&&this.channels[e].length>0)},this.getSubscriberCount=function(e){return this.channels[e]&&this.channels[e].length||0},this},n=(new r).create(),s=function(e={}){const n=new Map,s=new r;let o=e;const i=e=>{if(!n.has(e))return!1;const t=n.get(e);if(t&&"function"==typeof t.destroy)try{t.destroy()}catch(t){console.error(`Error destroying module ${e}:`,t)}return n.delete(e),s.remove(`module:${e}`),s.emit("module:unregistered",{name:e}).catch(e=>{console.error("Error emitting unregister event:",e)}),console.log(`Module unregistered: ${e}`),!0},a=()=>Array.from(n.keys()),c={create:()=>c,register:(e,t)=>{if(!e||"string"!=typeof e)throw new Error("Module name must be a non-empty string");return n.set(e,t),s.add(`module:${e}`,()=>({name:e,instance:t})),s.emit("module:registered",{name:e,instance:t}).then(()=>{console.log(`Module registered: ${e}`)}).catch(e=>{console.error("Error registering module:",e)}),t},unregister:i,get:e=>n.get(e),has:e=>n.has(e),list:a,clear:()=>{a().forEach(e=>i(e)),n.clear()},setGlobal:e=>(o=t.isObj(e)?t.merge({},o,e):o,o),getGlobal:()=>o,on:(e,t,r)=>s.add(e,t,r),off:(e,t,r)=>s.remove(e,t,r),emit:(e,t)=>s.emit(e,t),fire:(e,t)=>s.fire(e,t),broker:s};return c},o=function(){return this.create=function(e,r,n={},s){const o={id:r,module:s,options:n,utils:t};return console.log("gui in sandbox = ",e),e.broker.install(o),o.broker=e.broker,o.add=e.broker.add.bind(e.broker),o.remove=e.broker.remove.bind(e.broker),o.emit=e.broker.emit.bind(e.broker),o.fire=e.broker.fire.bind(e.broker),o.data=$.data,o.deferred=()=>$.Deferred(),o.animation=$.Animation,o.fetch=(e,t={})=>new Promise((r,n)=>{$.ajax({url:"string"==typeof e?e:e.url,...t,success:(e,t,n)=>r({data:e,textStatus:t,jqXHR:n}),error:(e,t)=>n(new Error(t||"Ajax failed"))})}),o.query=function(e,t){const r=t&&t.find?t.find(e):$(e);return r.query=e=>o.query(e,r),r.create=e=>document.createElement(e),r.size=()=>parseFloat(window.getComputedStyle(r[0]||r).fontSize),r.animateAsync=(e,t,n)=>new Promise((s,o)=>{r.animate(e,{duration:t,easing:n,complete:()=>s(r),fail:e=>o(e)})}).catch(e=>Promise.reject(e)),r.onAsync=(e,t)=>new Promise(n=>{const s=o=>{r.off(e,t,s),n(o)};t?r.on(e,t,s):r.on(e,s)}),r},o.$=o.query,o.timeout=(e,t)=>new Promise(r=>{setTimeout(()=>r(t&&"function"==typeof t?t():void 0),e)}),o.interval=(e,t,r)=>{let n,s=0,o=!1;return{stop:()=>{o=!0,n&&clearInterval(n)},promise:new Promise((i,a)=>{n=setInterval(()=>{if(o)return clearInterval(n),void i(s);Promise.resolve().then(()=>e()).then(()=>{s++,r&&s>=r&&(clearInterval(n),i(s))}).catch(e=>{clearInterval(n),a(e)})},t)})}},o.hitch=function(e,...t){return function(...r){const n=t.concat(r);return e.apply(this,n)}},o.memoize=(e,t,r)=>(t=t||{},(...n)=>{const s=n.length>1?n.join("__"):String(n[0]||"");if(!(s in t)||r&&t[s]===r){const r=e.apply(e,n);r&&"function"==typeof r.then?t[s]=r.catch(e=>(delete t[s],Promise.reject(e))):t[s]=r}return t[s]}),o.loadResources=(e,t={})=>{const r=(Array.isArray(e)?e:[e]).map(e=>{if("string"==typeof e){const t=e;switch(t.split(".").pop().toLowerCase()){case"css":return o.loadCSS(t);case"js":return o.loadScript(t);case"json":return o.fetch(t).then(e=>e.data);default:return o.fetch(t)}}else if(e&&e.type&&e.url)switch(e.type){case"css":return o.loadCSS(e.url);case"script":return o.loadScript(e.url);case"json":return o.fetch(e.url).then(e=>e.data);default:return o.fetch(e.url)}return Promise.reject(new Error("Invalid resource format"))});return Promise.all(r)},o.loadCSS=e=>new Promise((t,r)=>{const n=document.createElement("link");n.rel="stylesheet",n.type="text/css",n.href=e,n.onload=()=>t(n),n.onerror=()=>r(new Error(`Failed to load CSS: ${e}`)),document.head.appendChild(n)}),o.loadScript=e=>new Promise((t,r)=>{const n=document.createElement("script");n.type="text/javascript",n.src=e,n.onload=()=>t(n),n.onerror=()=>r(new Error(`Failed to load script: ${e}`)),document.head.appendChild(n)}),o.getLocation=()=>e.config.win&&e.config.win.location,o.log=(...t)=>e.debug.log(...t),o.warn=(...t)=>e.debug.warn(...t),o.ready=()=>new Promise(e=>$(document).ready(e)),o.loaded=()=>new Promise(e=>$(window).on("load",e)),o},this},i=function(){const n=this;this.config={logLevel:0,name:"FEAR_GUI",version:"2.0.0"},this.debug={history:[],level:this.config.logLevel,timeout:5e3,warn(...e){n.debug.level<2&&(console.warn("WARN:",...e),n.debug.history.push({type:"warn",args:e}))},log(...e){n.debug.level<1&&(console.log("Debug:",...e),n.debug.history.push({type:"log",args:e}))}},this.state={modules:{},plugins:[],instances:{},sandboxes:{},running:{},imports:[]},this.broker=(new r).create(),this.registry=(new s).create(this.config),this.utils=t;const i=(e,r)=>{const s=n.state.plugins.filter(t=>"function"==typeof t.plugin?.[e]).map(t=>()=>Promise.resolve(t.plugin[e](r,t.options)));return t.run.series(s)},a=e=>{e||(e=Object.keys(n.state.modules));const r=e.map(e=>()=>n.start(e,n.state.modules[e].options));return t.run.parallel(r)};return this.configure=function(e){return e&&t.isObj(e)&&(n.config=t.merge(n.config,e),n.registry.setGlobal(n.config),n.debug.level=n.config.logLevel||0),n},this.create=function(e,r,s={}){const o=t.isType("string",e,"module ID")||t.isType("function",r,"creator")||t.isType("object",s,"option parameter");return o?(n.debug.warn(`could not register module '${e}': ${o}`),n):(n.state.modules[e]={id:e,creator:r,options:s},n)},this.start=function(e,r={}){const s=r.instanceId||e,c=t.isType("string",e,"module ID")||t.isType("object",r,"second parameter")||(n.state.modules[e]?void 0:"module doesn't exist");return e?t.isArr(e)?a(e):t.isFunc(e)?a():c?Promise.reject(new Error(c)):!0===n.state.running[s]?Promise.reject(new Error("module was already started")):n.boot().then(()=>((e,t)=>{const r=t.instanceId||e;if(n.state.instances[r])return Promise.resolve({instance:n.state.instances[r],options:t.options});const s=n.state.modules[e],a={...s.options,...t.options},c=(new o).create(n,r,a,e);return i("load",c).then(()=>{const e=s.creator(c);if("function"!=typeof e.load){if(e.fn&&"function"==typeof e.fn)return n.plugin(e,r),{instance:e,options:a};throw new Error("module has no 'load' or 'fn' method")}return n.state.instances[r]=e,n.state.sandboxes[r]=c,n.registry.register(r,e),{instance:e,options:a}})})(e,r)).then(({instance:e,options:t})=>{if(e.load&&"function"==typeof e.load){const r=e.load(t);return r&&"function"==typeof r.then?r.then(()=>{n.state.running[s]=!0}):(n.state.running[s]=!0,Promise.resolve())}return n.state.running[s]=!0,Promise.resolve()}).catch(e=>{throw n.debug.warn(e),new Error("could not start module: "+e.message)}):a()},this.stop=function(e){if(0===arguments.length||"function"==typeof e){const e=Object.keys(n.state.instances);return t.run.parallel(e.map(e=>()=>n.stop(e)))}const r=n.state.instances[e];return r?(delete n.state.instances[e],n.broker.remove(r),n.registry.unregister(e),i("unload",n.state.sandboxes[e]).then(()=>{if(r.unload&&"function"==typeof r.unload){const e=r.unload();if(e&&"function"==typeof e.then)return e}return Promise.resolve()}).then(()=>{delete n.state.running[e]})):Promise.resolve()},this.use=function(e,r){if(t.isArr(e))e.forEach(e=>{t.isFunc(e)?n.use(e):t.isObj(e)&&n.use(e.plugin,e.options)});else{if(!t.isFunc(e))return n;n.state.plugins.push({creator:e,options:r})}return n},this.plugin=function(r,s){return r.fn&&t.isFunc(r.fn)?e.$.fn[s.toLowerCase()]=function(e){return new r.fn(this,e)}:n.debug.log("Error :: Missing "+r+" fn() method."),n},this.boot=function(){const e=n.state.plugins.filter(e=>!0!==e.booted).map(e=>()=>new Promise((r,s)=>{t.hasArgs(e.creator,3)?e.creator(n,e.options,t=>{t?s(t):(e.booted=!0,r())}):Promise.resolve().then(()=>{e.plugin=e.creator(n,e.options),e.booted=!0,r()}).catch(e=>s(e))}));return t.run.series(e)},this.attach=function(e){return Promise.resolve().then(()=>{n.debug.log("Dynamic async module loading."),n.debug.log("Imports:",e)})},this},a=()=>new i;new i;const c=a().create("Metrics",e=>{let t=null,r=null,n=null;const s=e=>{const t=Math.floor(e/1e3),r=Math.floor(t/60),n=Math.floor(r/60);return n>0?`${n}h ${r%60}m`:r>0?`${r}m ${t%60}s`:`${t}s`};return{load:(o={})=>{if(e.log("Metrics module loading with options:",o),t=((t=!0)=>{const r={enabled:t,metrics:{routeLoadTimes:new Map,moduleLoadTimes:new Map,totalRoutes:0,totalModules:0,cacheHits:0,cacheMisses:0,errors:0,startTime:Date.now()},timings:new Map},n=()=>{const e=r.metrics.cacheHits+r.metrics.cacheMisses;return e>0?(r.metrics.cacheHits/e*100).toFixed(2):0},s=e=>{const t="route"===e?r.metrics.routeLoadTimes:r.metrics.moduleLoadTimes;return 0===t.size?0:(Array.from(t.values()).reduce((e,t)=>e+t,0)/t.size).toFixed(2)};return{startTiming:e=>{if(!r.enabled)return null;const t=performance.now();return r.timings.set(e,t),t},endTiming:e=>{if(!r.enabled||!r.timings.has(e))return 0;const t=r.timings.get(e),n=performance.now()-t;return e.startsWith("route:")?(r.metrics.routeLoadTimes.set(e,n),r.metrics.totalRoutes++):e.startsWith("module:")&&(r.metrics.moduleLoadTimes.set(e,n),r.metrics.totalModules++),r.timings.delete(e),n},recordCacheHit:()=>{r.enabled&&r.metrics.cacheHits++},recordCacheMiss:()=>{r.enabled&&r.metrics.cacheMisses++},recordError:t=>{r.enabled&&(r.metrics.errors++,e.log("Error recorded:",t))},getMetrics:()=>({...r.metrics,routeLoadTimes:Array.from(r.metrics.routeLoadTimes.entries()),moduleLoadTimes:Array.from(r.metrics.moduleLoadTimes.entries()),uptime:Date.now()-r.metrics.startTime,cacheHitRate:n(),averageRouteLoadTime:s("route"),averageModuleLoadTime:s("module")}),getCacheHitRate:n,getAverageLoadTime:s,reset:()=>{r.metrics={routeLoadTimes:new Map,moduleLoadTimes:new Map,totalRoutes:0,totalModules:0,cacheHits:0,cacheMisses:0,errors:0,startTime:Date.now()},r.timings.clear()}}})(!1!==o.enabled),e.add("route:start",r=>{const n=`route:${r.path||"unknown"}`;t.startTiming(n),e.log("Route started:",n)}),e.add("route:complete",r=>{const n=`route:${r.path||"unknown"}`,s=t.endTiming(n);e.log(`Route completed: ${n} in ${s}ms`),e.emit("metrics:updated",t.getMetrics())}),e.add("module:start",r=>{const n=`module:${r.name||"unknown"}`;t.startTiming(n),e.log("Module started:",n)}),e.add("module:complete",r=>{const n=`module:${r.name||"unknown"}`,s=t.endTiming(n);e.log(`Module loaded: ${n} in ${s}ms`),e.emit("metrics:updated",t.getMetrics())}),e.add("cache:hit",()=>{t.recordCacheHit()}),e.add("cache:miss",()=>{t.recordCacheMiss()}),e.add("error",e=>{t.recordError(e)}),o.displayMetrics){n=e.$("#metrics-display"),0===n.length&&(n=e.$('<div id="metrics-display"></div>'),e.$("body").append(n));const i=o.updateInterval||5e3;r=setInterval(()=>{(()=>{if(!n||!t)return;const e=t.getMetrics(),r=`\n      <div class="metrics-panel">\n        <h3>Performance Metrics</h3>\n        <div class="metric-item">\n          <span class="label">Uptime:</span>\n          <span class="value">${s(e.uptime)}</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Total Routes:</span>\n          <span class="value">${e.totalRoutes}</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Total Modules:</span>\n          <span class="value">${e.totalModules}</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Avg Route Load:</span>\n          <span class="value">${e.averageRouteLoadTime}ms</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Avg Module Load:</span>\n          <span class="value">${e.averageModuleLoadTime}ms</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Cache Hit Rate:</span>\n          <span class="value">${e.cacheHitRate}%</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Cache Hits:</span>\n          <span class="value">${e.cacheHits}</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Cache Misses:</span>\n          <span class="value">${e.cacheMisses}</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Errors:</span>\n          <span class="value">${e.errors}</span>\n        </div>\n      </div>\n    `;n.html(r)})()},i)}return e.metrics={start:e=>t.startTiming(e),end:e=>t.endTiming(e),cacheHit:()=>t.recordCacheHit(),cacheMiss:()=>t.recordCacheMiss(),recordError:e=>t.recordError(e),get:()=>t.getMetrics(),reset:()=>t.reset()},e.log("Metrics module loaded successfully"),Promise.resolve()},unload:()=>(e.log("Metrics module unloading"),r&&(clearInterval(r),r=null),n&&(n.remove(),n=null),delete e.metrics,Promise.resolve()),destroy:()=>{e.log("Metrics module destroying"),t&&(t.reset(),t=null)},getSnapshot:()=>t?t.getMetrics():null,reset:()=>{t&&(t.reset(),e.emit("metrics:reset"),e.log("Metrics reset"))}}},{enabled:!0,displayMetrics:!1,updateInterval:5e3});$.FEAR=function(e){const t=a();return e&&t.configure(e),t},$.FEAR.utils=t,$.FEAR.createBroker=n,$.FEAR.createRegistry=()=>(new s).create(),$.FEAR.Metrics=c,$.FEAR.version="1.0.2",$.fear=a(),window.FEAR=$.FEAR,window.fear=$.fear});
