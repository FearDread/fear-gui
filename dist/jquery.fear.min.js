!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){"use strict";const e={merge:$.extend,each:Object.prototype.forEach,has:Object.prototype.hasOwnProperty,slice:Array.prototype.slice,isObj:e=>$.isPlainObject(e),isArr:e=>$.isArray(e),isFunc:e=>!!(e&&e.constructor&&e.call&&e.apply),isStr:e=>"string"==typeof e,isType:(e,t,n)=>{if(typeof t!==e)return`Error :: ${n} must be of type ${e}`},hasArgs:(e,t=1)=>{const n=e.toString().match(/\(([^)]*)\)/);return(n&&n[1].match(/[^\s,]+/g)||[]).length>=t},inject:(t,n)=>{var r;for(r in n)e.hasProp.call(n,r)&&(t[r]=n[r]);function i(){this.constructor=t}return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},isRetina:()=>window.retina||window.devicePixelRatio>1,isMobile:e=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e),getObjectSize:e=>{var t,n=0;for(t in e)e.hasOwnProperty(t)&&(n+=1);return n},getPxValue:(e,t)=>{var n;switch(t){case"em":n=this.convertToEm(e);break;case"pt":n=this.convertToPt(e);break;default:n=e}return n},rand:(e,t)=>Math.floor(Math.random()*(t-e+1))+e,args:t=>{var n;return((null!==t&&null!==(n=t.toString().match(e.fnRgx))?n[1]:void 0)||"").match(e.argRgx)||[]},resize:e=>{e.height||(e=$(e)),$(()=>{$(window).resize(()=>{e.height($(window).height())}),$(window).resize()})},slugify:e=>e.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,""),clone:e=>{var t,n,r;if(e instanceof Array)t=(()=>{var t,n,i;for(i=[],t=0,n=e.length;t<n;t++)r=e[t],i.push(r);return i})();else for(n in t={},e)r=e[n],t[n]=r;return t},convertToEm:e=>e*this.getFontsize(),convertToPt:e=>{},convertBase:()=>{var e=document.createElement(),t=e.getAttribute("style");return e.setAttribute("style",t+";font-size:1em !important"),e.setAttribute("style",t),base=this.getFontsize(),base},mix:(e,t,n)=>{var r,i,s;if(!0===n){for(r in i=[],e)s=e[r],i.push(t[r]=s);return i}for(r in e)s=e[r],t.hasOwnProperty(r)||i.push(t[r]=s);return i},mixin:function(e,t,n){switch(n&&null!==n||(n=!1),typeof t+"-"+typeof e){case" - ":return this.mix(t.prototype,e.prototype,n);case" -object":return this.mix(t.prototype,e,n);case"object-object":return this.mix(t,e,n);case"object- ":return this.mix(t,e.prototype,n)}},unique:e=>{var t="";for(e&&null!==e||(e=8);t.length<e;)t+=Math.random().toString(36).substr(2);return t.substr(0,e)},run:{series:(e=[])=>e.length?e.reduce((e,t,n)=>e.then(e=>Promise.resolve(t()).then(t=>[...e,t]).catch(e=>{const t=new Error(`Task ${n} failed`);throw t.originalError=e,t})),Promise.resolve([])):Promise.resolve([]),parallel:(e=[])=>e.length?Promise.all(e.map(e=>Promise.resolve(e()))):Promise.resolve([]),first:(t=[])=>t.length?t[0]().catch(()=>{if(t.length>1)return e.run.first(t.slice(1));throw new Error("All tasks failed")}):Promise.resolve(null)}},t=function(n={}){const r=this;return this.channels={},this.cascade=n.cascade||!1,this.fireOrigin=n.fireOrigin||!1,this.debug=n.debug||!1,this._delete=(t,n,r)=>{if(!this.channels[t])return[];const i=this.channels[t].length;this.channels[t]=this.channels[t].filter(e=>(!n||e.callback!==n)&&((!r||e.context!==r)&&!(!n&&!r&&e.context===this)));const s=i-this.channels[t].length;return s>0&&e.log(`Removed ${s} subscription(s) from '${t}'`),this.channels[t]},this._setupTasks=(t,n,r)=>(this.channels[n]||[]).map(n=>()=>new Promise((i,s)=>{if(e.hasArgs(n.callback,3))n.callback.call(n.context,t,r,(e,t)=>{e?s(e):i(t)});else{const e=n.callback.call(n.context,t,r);e&&"function"==typeof e.then?e.then(i).catch(s):i(e)}}).catch(e=>Promise.reject(e))),this._formatErrors=t=>{if(e.isArr(t)){const e=t.filter(e=>null!=e).map(e=>e.message||String(e)),n=new Error(e.join("; "));return n.originalErrors=t,n}return t},this.create=()=>new t,this.add=function(e,t,n){if("string"!=typeof e)throw new Error("Channel must be a string");if("function"!=typeof t)throw new Error("Callback must be a function");this.channels[e]||(this.channels[e]=[]);const r={event:e,context:n||this,callback:t};return this.channels[e].push(r),this},this.remove=function(e,t,n){switch(typeof e){case"string":"function"==typeof t?this._delete(e,t,n):void 0===t&&this._delete(e);break;case"function":Object.keys(this.channels).forEach(t=>{this._delete(t,e)});break;case"undefined":this.clear();break;case"object":null!==e&&Object.keys(this.channels).forEach(t=>{this._delete(t,null,e)})}return this},this.once=function(e,t,n){if("string"!=typeof e)throw new Error("Channel must be a string");if("function"!=typeof t)throw new Error("Callback must be a function");let r=!1;const i=(...s)=>{if(!r)return r=!0,this.remove(e,i),t.apply(n||this,s)};return this.add(e,i,n)},this.clear=function(){return Object.keys(this.channels).forEach(e=>delete this.channels[e]),e.log("All channels cleared"),this},this.fire=function(t,n){if("string"!=typeof t)return Promise.reject(new Error("Channel must be a string"));"function"==typeof n&&(n=void 0);const i=r._setupTasks(n,t,t);return 0===i.length?Promise.resolve(null):e.run.first(i).catch(e=>{throw r._formatErrors(e)})},this.emit=function(t,n,i){if("string"!=typeof t)return Promise.reject(new Error("Channel must be a string"));n&&e.isFunc(n)&&(n=void 0),i=i||t;const s=r._setupTasks(n,t,i);return e.run.series(s).then(e=>{if(r.cascade){const s=t.split("/");if(s.length>1){const t=s.slice(0,-1).join("/"),o=r.fireOrigin?i:t;return this.emit(t,n,o).then(()=>e)}}return e}).catch(e=>{throw r._formatErrors(e)})},this.waitFor=function(e,t){return new Promise((n,r)=>{let i;t&&t>0&&(i=setTimeout(()=>{this.remove(e,s),r(new Error(`Timeout waiting for event '${e}' after ${t}ms`))},t));const s=(t,r)=>{i&&clearTimeout(i),this.remove(e,s),n({data:t,origin:r,channel:e})};this.add(e,s)})},this.pipe=function(e,t,n){return t&&(t.fire||t.emit)&&(n=t,t=e),n||(n=this),n===this&&e===t||this.add(e,(...e)=>n.fire(t,...e)),this},this.namespace=function(e){const t=e+"/";return{add:(e,n,r)=>this.add(t+e,n,r),remove:(e,n,r)=>this.remove(t+e,n,r),fire:(e,n)=>this.fire(t+e,n),emit:(e,n,r)=>this.emit(t+e,n,r),once:(e,n,r)=>this.once(t+e,n,r),waitFor:(e,n)=>this.waitFor(t+e,n),pipe:(e,n,r)=>this.pipe(t+e,t+n,r),getSubscriberCount:e=>this.getSubscriberCount(t+e),clear:()=>(Object.keys(this.channels).forEach(e=>{e.startsWith(t)&&delete this.channels[e]}),this)}},this.install=function(t,n=!1){return e.isObj(t)?(Object.keys(this).forEach(e=>{const r=this[e];"function"!=typeof r||!n&&t[e]||(t[e]=r.bind(this))}),this):this},this.getChannels=function(){return Object.keys(this.channels).filter(e=>this.channels[e]&&this.channels[e].length>0)},this.getSubscriberCount=function(e){return this.channels[e]&&this.channels[e].length||0},this};(new t).create();const n=function(n={}){const r=new Map,i=new t;let s=n;const o=e=>{if(!r.has(e))return!1;const t=r.get(e);if(t&&"function"==typeof t.destroy)try{t.destroy()}catch(t){console.error(`Error destroying module ${e}:`,t)}return r.delete(e),i.remove(`module:${e}`),i.emit("module:unregistered",{name:e}).catch(e=>{console.error("Error emitting unregister event:",e)}),console.log(`Module unregistered: ${e}`),!0},a=()=>Array.from(r.keys()),c={create:()=>c,register:(e,t)=>{if(!e||"string"!=typeof e)throw new Error("Module name must be a non-empty string");return r.set(e,t),i.add(`module:${e}`,()=>({name:e,instance:t})),i.emit("module:registered",{name:e,instance:t}).then(()=>{console.log(`Module registered: ${e}`)}).catch(e=>{console.error("Error registering module:",e)}),t},unregister:o,get:e=>r.get(e),has:e=>r.has(e),list:a,clear:()=>{a().forEach(e=>o(e)),r.clear()},setGlobal:t=>(s=e.isObj(t)?e.merge({},s,t):s,s),getGlobal:()=>s,on:(e,t,n)=>i.add(e,t,n),off:(e,t,n)=>i.remove(e,t,n),emit:(e,t)=>i.emit(e,t),fire:(e,t)=>i.fire(e,t),broker:i};return c},r=function(){return this.create=function(t,n,r={},i){const s={id:n,module:i,options:r,utils:e};return console.log("gui in sandbox = ",t),t.broker.install(s),s.broker=t.broker,s.add=t.broker.add.bind(t.broker),s.remove=t.broker.remove.bind(t.broker),s.emit=t.broker.emit.bind(t.broker),s.fire=t.broker.fire.bind(t.broker),s.data=$.data,s.deferred=()=>$.Deferred(),s.animation=$.Animation,s.fetch=(e,t={})=>new Promise((n,r)=>{$.ajax({url:"string"==typeof e?e:e.url,...t,success:(e,t,r)=>n({data:e,textStatus:t,jqXHR:r}),error:(e,t)=>r(new Error(t||"Ajax failed"))})}),s.query=function(e,t){const n=t&&t.find?t.find(e):$(e);return n.query=e=>s.query(e,n),n.create=e=>document.createElement(e),n.size=()=>parseFloat(window.getComputedStyle(n[0]||n).fontSize),n.animateAsync=(e,t,r)=>new Promise((i,s)=>{n.animate(e,{duration:t,easing:r,complete:()=>i(n),fail:e=>s(e)})}).catch(e=>Promise.reject(e)),n.onAsync=(e,t)=>new Promise(r=>{const i=s=>{n.off(e,t,i),r(s)};t?n.on(e,t,i):n.on(e,i)}),n},s.$=s.query,s.timeout=(e,t)=>new Promise(n=>{setTimeout(()=>n(t&&"function"==typeof t?t():void 0),e)}),s.interval=(e,t,n)=>{let r,i=0,s=!1;return{stop:()=>{s=!0,r&&clearInterval(r)},promise:new Promise((o,a)=>{r=setInterval(()=>{if(s)return clearInterval(r),void o(i);Promise.resolve().then(()=>e()).then(()=>{i++,n&&i>=n&&(clearInterval(r),o(i))}).catch(e=>{clearInterval(r),a(e)})},t)})}},s.hitch=function(e,...t){return function(...n){const r=t.concat(n);return e.apply(this,r)}},s.memoize=(e,t,n)=>(t=t||{},(...r)=>{const i=r.length>1?r.join("__"):String(r[0]||"");if(!(i in t)||n&&t[i]===n){const n=e.apply(e,r);n&&"function"==typeof n.then?t[i]=n.catch(e=>(delete t[i],Promise.reject(e))):t[i]=n}return t[i]}),s.loadResources=(e,t={})=>{const n=(Array.isArray(e)?e:[e]).map(e=>{if("string"==typeof e){const t=e;switch(t.split(".").pop().toLowerCase()){case"css":return s.loadCSS(t);case"js":return s.loadScript(t);case"json":return s.fetch(t).then(e=>e.data);default:return s.fetch(t)}}else if(e&&e.type&&e.url)switch(e.type){case"css":return s.loadCSS(e.url);case"script":return s.loadScript(e.url);case"json":return s.fetch(e.url).then(e=>e.data);default:return s.fetch(e.url)}return Promise.reject(new Error("Invalid resource format"))});return Promise.all(n)},s.loadCSS=e=>new Promise((t,n)=>{const r=document.createElement("link");r.rel="stylesheet",r.type="text/css",r.href=e,r.onload=()=>t(r),r.onerror=()=>n(new Error(`Failed to load CSS: ${e}`)),document.head.appendChild(r)}),s.loadScript=e=>new Promise((t,n)=>{const r=document.createElement("script");r.type="text/javascript",r.src=e,r.onload=()=>t(r),r.onerror=()=>n(new Error(`Failed to load script: ${e}`)),document.head.appendChild(r)}),s.getLocation=()=>t.config.win&&t.config.win.location,s.log=(...e)=>t.debug.log(...e),s.warn=(...e)=>t.debug.warn(...e),s.ready=()=>new Promise(e=>$(document).ready(e)),s.loaded=()=>new Promise(e=>$(window).on("load",e)),s},this},i=function(){const i=this;this.config={logLevel:0,name:"FEAR_GUI",version:"2.0.0"},this.debug={history:[],level:this.config.logLevel,timeout:5e3,warn(...e){i.debug.level<2&&(console.warn("WARN:",...e),i.debug.history.push({type:"warn",args:e}))},log(...e){i.debug.level<1&&(console.log("Debug:",...e),i.debug.history.push({type:"log",args:e}))}},this.state={modules:{},plugins:[],instances:{},sandboxes:{},running:{},imports:[]},this.broker=(new t).create(),this.registry=(new n).create(this.config),this.utils=e;const s=(t,n)=>{const r=i.state.plugins.filter(e=>"function"==typeof e.plugin?.[t]).map(e=>()=>Promise.resolve(e.plugin[t](n,e.options)));return e.run.series(r)},o=t=>{t||(t=Object.keys(i.state.modules));const n=t.map(e=>()=>i.start(e,i.state.modules[e].options));return e.run.parallel(n)};return this.configure=function(t){return t&&e.isObj(t)&&(i.config=e.merge(i.config,t),i.registry.setGlobal(i.config),i.debug.level=i.config.logLevel||0),i},this.create=function(t,n,r={}){const s=e.isType("string",t,"module ID")||e.isType("function",n,"creator")||e.isType("object",r,"option parameter");return s?(i.debug.warn(`could not register module '${t}': ${s}`),i):(i.state.modules[t]={id:t,creator:n,options:r},i)},this.start=function(t,n={}){const a=n.instanceId||t,c=e.isType("string",t,"module ID")||e.isType("object",n,"second parameter")||(i.state.modules[t]?void 0:"module doesn't exist");return t?e.isArr(t)?o(t):e.isFunc(t)?o():c?Promise.reject(new Error(c)):!0===i.state.running[a]?Promise.reject(new Error("module was already started")):i.boot().then(()=>((e,t)=>{const n=t.instanceId||e;if(i.state.instances[n])return Promise.resolve({instance:i.state.instances[n],options:t.options});const o=i.state.modules[e],a={...o.options,...t.options},c=(new r).create(i,n,a,e);return s("load",c).then(()=>{const e=o.creator(c);if("function"!=typeof e.load){if(e.fn&&"function"==typeof e.fn)return i.plugin(e,n),{instance:e,options:a};throw new Error("module has no 'load' or 'fn' method")}return i.state.instances[n]=e,i.state.sandboxes[n]=c,i.registry.register(n,e),{instance:e,options:a}})})(t,n)).then(({instance:e,options:t})=>{if(e.load&&"function"==typeof e.load){const n=e.load(t);return n&&"function"==typeof n.then?n.then(()=>{i.state.running[a]=!0}):(i.state.running[a]=!0,Promise.resolve())}return i.state.running[a]=!0,Promise.resolve()}).catch(e=>{throw i.debug.warn(e),new Error("could not start module: "+e.message)}):o()},this.stop=function(t){if(0===arguments.length||"function"==typeof t){const t=Object.keys(i.state.instances);return e.run.parallel(t.map(e=>()=>i.stop(e)))}const n=i.state.instances[t];return n?(delete i.state.instances[t],i.broker.remove(n),i.registry.unregister(t),s("unload",i.state.sandboxes[t]).then(()=>{if(n.unload&&"function"==typeof n.unload){const e=n.unload();if(e&&"function"==typeof e.then)return e}return Promise.resolve()}).then(()=>{delete i.state.running[t]})):Promise.resolve()},this.use=function(t,n){if(e.isArr(t))t.forEach(t=>{e.isFunc(t)?i.use(t):e.isObj(t)&&i.use(t.plugin,t.options)});else{if(!e.isFunc(t))return i;i.state.plugins.push({creator:t,options:n})}return i},this.plugin=function(t,n){return t.fn&&e.isFunc(t.fn)?$.fn[n.toLowerCase()]=function(e){return new t.fn(this,e)}:i.debug.log("Error :: Missing "+t+" fn() method."),i},this.boot=function(){const t=i.state.plugins.filter(e=>!0!==e.booted).map(t=>()=>new Promise((n,r)=>{e.hasArgs(t.creator,3)?t.creator(i,t.options,e=>{e?r(e):(t.booted=!0,n())}):Promise.resolve().then(()=>{t.plugin=t.creator(i,t.options),t.booted=!0,n()}).catch(e=>r(e))}));return e.run.series(t)},this.attach=function(e){return Promise.resolve().then(()=>{i.debug.log("Dynamic async module loading."),i.debug.log("Imports:",e)})},this},s=new i,o=function(e={}){const t=this;return this.options=FEAR.utils.merge({},{container:"#router-container",fragmentPath:"/fragments/",defaultRoute:"home",pushState:!0,hashNavigation:!0,smoothScroll:!0,scrollOffset:0,activeClass:"active",loading:{enabled:!0,template:'<div class="router-loading">Loading...</div>',minDisplay:300},animations:{enabled:!0,fadeSpeed:300},cache:{enabled:!0,maxSize:50,ttl:36e5},performance:{trackMetrics:!0},accessibility:{announceRoutes:!0,focusContent:!0},retry:{enabled:!0,maxAttempts:3,delay:1e3},callbacks:{beforeRouteChange:null,afterRouteChange:null,onRouteChange:null,onError:null,onDestroy:null},routes:{}},e),this.routes=this.options.routes,this.currentRoute=null,this.previousRoute=null,this.isNavigating=!1,this.initialized=!1,this.loadingPromises=new Map,this.retryAttempts=new Map,this.$container=null,this.$announcer=null,this.cache=new Map,this.cacheTimestamps=new Map,this._handleHashChange=()=>{if(!this.isNavigating){const e=window.location.hash.slice(1)||this.options.defaultRoute;this._loadRoute(e)}},this._handlePopState=e=>{const t=e.originalEvent?.state;t&&t.route?this._loadRoute(t.route):this._handleHashChange()},this._handleLinkClick=e=>{const n=$(e.currentTarget).attr("href");if(n&&n.startsWith("#")&&n.length>1){e.preventDefault();const r=n.slice(1);t.options.smoothScroll&&t._scrollToSection(r),t.navigate(r,!0)}},this._loadRoute=function(e){if(this.isNavigating)return console.warn("Navigation already in progress"),Promise.resolve();const t=this.routes[e];return t?(this.isNavigating=!0,FEAR.broker.emit("route:start",{path:e}).then(()=>{if(this.options.callbacks.beforeRouteChange)return Promise.resolve(this.options.callbacks.beforeRouteChange.call(this,e,this.currentRoute))}).then(n=>!1===n?(this.isNavigating=!1,Promise.reject(new Error("Route change cancelled"))):(this.previousRoute=this.currentRoute,this.currentRoute=e,this.options.loading.enabled&&!t.html&&this._showLoading(),t.html?this._renderRoute(t):this._fetchRoute(t))).then(()=>(console.log(`Route "${e}" loaded successfully`),FEAR.broker.emit("route:complete",{path:e}))).catch(t=>(this._handleError(`Failed to load route "${e}": ${t.message}`,t),Promise.reject(t))).then(()=>{this.isNavigating=!1,this._hideLoading()})):(console.warn(`Route "${e}" not found`),Promise.reject(new Error(`Route not found: ${e}`)))},this._fetchRoute=function(e){const t=this._getCachedRoute(e.name);if(t)return FEAR.broker.emit("cache:hit"),e.html=t,this._renderRoute(e);if(FEAR.broker.emit("cache:miss"),this.loadingPromises.has(e.name))return this.loadingPromises.get(e.name).then(t=>(e.html=t,this._renderRoute(e)));const n=this.options.fragmentPath+(e.path||e.name+".html"),r=this._createLoadingPromise(n,e.name);return this.loadingPromises.set(e.name,r),r.then(t=>(e.html=t,this._setCachedRoute(e.name,t),this._renderRoute(e))).then(()=>{this.loadingPromises.delete(e.name)}).catch(t=>(this.loadingPromises.delete(e.name),Promise.reject(t)))},this._renderRoute=function(e){const t=this.options.animations.enabled&&!this._prefersReducedMotion()?this.options.animations.fadeSpeed:0;return new Promise((n,r)=>{this.$container.fadeOut(t,()=>{Promise.resolve().then(()=>(this.$container.empty().html(e.html),this._updateMetadata(e),new Promise(e=>{this.$container.fadeIn(t,()=>e())}))).then(()=>{if(e.callback&&"function"==typeof e.callback)return Promise.resolve(e.callback.call(this,e))}).then(()=>{if(this._initComponents(),this._handleAccessibility(e),this.options.callbacks.afterRouteChange)return Promise.resolve(this.options.callbacks.afterRouteChange.call(this,e.name,this.previousRoute))}).then(()=>{if(this.options.callbacks.onRouteChange)return Promise.resolve(this.options.callbacks.onRouteChange.call(this,e.name))}).then(()=>FEAR.broker.emit("router:rendered",{route:e.name})).then(()=>n()).catch(e=>{this._handleError(`Route callback error: ${e.message}`,e),n()})})})},this._createLoadingPromise=function(e,t){return new Promise((t,n)=>{$.ajax({url:e,dataType:"html",success:e=>t(e),error:(e,t,r)=>{n(new Error(t||"Failed to load route"))}})}).catch(n=>{const r=this.retryAttempts.get(t)||0;return this.options.retry.enabled&&r<this.options.retry.maxAttempts?(this.retryAttempts.set(t,r+1),console.log(`Retrying route load (${r+1}/${this.options.retry.maxAttempts})`),new Promise(e=>{setTimeout(()=>e(),this.options.retry.delay)}).then(()=>this._createLoadingPromise(e,t))):(this.retryAttempts.delete(t),Promise.reject(n))})},this._getCachedRoute=function(e){if(!this.options.cache.enabled)return null;const t=this.cacheTimestamps.get(e);if(!t)return null;return Date.now()-t>this.options.cache.ttl?(this.cache.delete(e),this.cacheTimestamps.delete(e),null):this.cache.get(e)},this._setCachedRoute=function(e,t){if(this.options.cache.enabled){if(this.cache.size>=this.options.cache.maxSize){const e=this.cache.keys().next().value;this.cache.delete(e),this.cacheTimestamps.delete(e)}this.cache.set(e,t),this.cacheTimestamps.set(e,Date.now())}},this._showLoading=function(){this.$container&&this.options.loading.template&&this.$container.html(this.options.loading.template)},this._hideLoading=function(){},this._updateMetadata=function(e){e.title&&(document.title=e.title),e.meta&&Object.keys(e.meta).forEach(t=>{let n=$(`meta[name="${t}"]`);0===n.length&&(n=$("<meta>").attr("name",t),$("head").append(n)),n.attr("content",e.meta[t])})},this._initComponents=function(){FEAR.broker.emit("components:init",{container:this.$container})},this._handleAccessibility=function(e){this.options.accessibility.announceRoutes&&(this.$announcer&&this.$announcer.text(`Navigated to ${e.title||e.name}`),this.options.accessibility.focusContent&&this.$container.attr("tabindex","-1").focus())},this._scrollToSection=function(e){const t=$(`#${e}, [name="${e}"]`).first();if(t.length){const e=t.offset().top-this.options.scrollOffset;$("html, body").animate({scrollTop:e},800)}},this._prefersReducedMotion=function(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches},this._handleError=function(e,t){console.error(e,t),FEAR.broker.emit("error",{message:e,error:t}),this.options.callbacks.onError&&this.options.callbacks.onError.call(this,t)},this._updateActiveStates=function(e){$(`a[href="#${e}"]`).addClass(this.options.activeClass).parent().siblings().find("a").removeClass(this.options.activeClass)},this.init=function(){if(this.initialized)return console.warn("Router already initialized"),this;if(this.$container=$(this.options.container),0===this.$container.length)return console.error(`Container "${this.options.container}" not found`),this;this.options.accessibility.announceRoutes&&(this.$announcer=$("<div>").attr({role:"status","aria-live":"polite","aria-atomic":"true"}).addClass("sr-only").appendTo("body")),this.options.hashNavigation&&$(window).on("hashchange.fear-router",this._handleHashChange),this.options.pushState&&$(window).on("popstate.fear-router",this._handlePopState),$(document).on("click.fear-router",'a[href^="#"]',this._handleLinkClick),this.initialized=!0;const e=window.location.hash.slice(1)||this.options.defaultRoute;return e&&this._loadRoute(e),console.log("Router initialized"),FEAR.broker.emit("router:ready"),this},this.navigate=function(e,t=!0){if(this.isNavigating)return console.warn("Navigation already in progress"),this;const n=this.routes[e];if(!n)return console.error(`Route "${e}" not found`),this;if(t&&this.options.pushState){const t={route:e};history.pushState(t,n.title||"",`#${e}`)}else window.location.hash=e;return this._updateActiveStates(e),this},this.addRoute=function(e,t){return this.routes[e]={name:e,path:e+".html",html:null,callback:null,title:e.charAt(0).toUpperCase()+e.slice(1),...t},console.log(`Route "${e}" added`),FEAR.broker.emit("router:route-added",{name:e,config:t}),this},this.removeRoute=function(e){return this.routes[e]&&(delete this.routes[e],this.cache.delete(e),this.cacheTimestamps.delete(e),console.log(`Route "${e}" removed`),FEAR.broker.emit("router:route-removed",{name:e})),this},this.reload=function(){if(this.currentRoute){const e=this.routes[this.currentRoute];e&&(this.cache.delete(this.currentRoute),this.cacheTimestamps.delete(this.currentRoute),e.html=null,this._loadRoute(this.currentRoute))}return this},this.clearCache=function(){return this.cache.clear(),this.cacheTimestamps.clear(),console.log("Cache cleared"),this},this.getCurrentRoute=function(){return this.currentRoute},this.getPreviousRoute=function(){return this.previousRoute},this.isReady=function(){return this.initialized&&!this.isNavigating},this.destroy=function(){return console.log("Destroying router instance"),$(window).off(".fear-router"),$(document).off(".fear-router"),this.cache.clear(),this.cacheTimestamps.clear(),this.loadingPromises.clear(),this.retryAttempts.clear(),this.$announcer&&this.$announcer.remove(),this.options.callbacks.onDestroy&&this.options.callbacks.onDestroy.call(this),FEAR.broker.emit("router:destroy"),this.initialized=!1,this},this.fn=function(e,t){return e.each(function(){const e=$(this);let n=e.data("fear-router");return n||(n=new o({...t,container:this}),e.data("fear-router",n),n.init()),n})},this},a=function(t={}){const n=this;return this._data={...t},this._listeners=new Map,this._computed=new Map,this._validators=new Map,this.get=function(e){return n._computed.has(e)?n._computed.get(e).call(n):n._data[e]},this.set=function(e,t){if(n._validators.has(e)){const r=n._validators.get(e)(t,n._data[e]);if(!0!==r)return Promise.reject(new Error(`Validation failed for ${e}: ${r}`))}const r=n._data[e];return r===t||(n._data[e]=t,n._notify(e,t,r),n._notify("*",{key:e,value:t,oldValue:r})),Promise.resolve(n)},this.update=function(t){const r=Object.keys(t).map(e=>()=>n.set(e,t[e]));return e.run.series(r).then(()=>n)},this.toJSON=function(){return{...n._data}},this.on=function(e,t){return n._listeners.has(e)||n._listeners.set(e,[]),n._listeners.get(e).push(t),()=>n.off(e,t)},this.off=function(e,t){if(!n._listeners.has(e))return;const r=n._listeners.get(e),i=r.indexOf(t);i>-1&&r.splice(i,1)},this.computed=function(e,t){return n._computed.set(e,t),n},this.validate=function(e,t){return n._validators.set(e,t),n},this._notify=function(e,t,r){n._listeners.has(e)&&n._listeners.get(e).forEach(e=>{e(t,r)})},this.reset=function(e={}){return n._data={...e},n._notify("*",{reset:!0}),n},this.fetch=function(e,t={}){return n.$GUI?n.$GUI.fetch(e,t).then(e=>t.parse&&"function"==typeof n.parse?n.parse(e.data):e.data).then(e=>n.update(e)):Promise.reject(new Error("$GUI not available for fetch"))},this.save=function(e,t={}){if(!n.$GUI)return Promise.reject(new Error("$GUI not available for save"));const r=n.toJSON(),i={method:"POST",contentType:"application/json",data:JSON.stringify(r),...t};return n.$GUI.fetch(e,i).then(e=>e.data)},this},c=function(e,t={}){const n=this;return this.$gui=e,this.options=t,this.el=t.el?$GUI.$(t.el):null,this.template=t.template||null,this.events=t.events||{},this._boundEvents=[],this.render=function(e={}){return n.el?Promise.resolve().then(()=>"function"==typeof n.template?n.template(e):"string"==typeof n.template?n._interpolate(n.template,e):"").then(t=>(n.el.html(t),n.delegateEvents(),n.afterRender(e))).then(()=>n):Promise.reject(new Error("View element not defined"))},this.afterRender=function(e){return Promise.resolve()},this._interpolate=function(e,t){return e.replace(/\{\{(\w+)\}\}/g,(e,n)=>void 0!==t[n]?t[n]:"")},this.delegateEvents=function(){return n.undelegateEvents(),Object.keys(n.events).forEach(e=>{const[t,r]=e.split(/\s+/),i=n.events[e],s="string"==typeof i?n[i]:i;if(!s)return void n.$GUI.warn(`Event handler ${i} not found`);const o=s.bind(n);n._boundEvents.push({event:t,selector:r,handler:o}),r?n.el.on(t,r,o):n.el.on(t,o)}),n},this.undelegateEvents=function(){return n._boundEvents.forEach(({event:e,selector:t,handler:r})=>{t?n.el.off(e,t,r):n.el.off(e,r)}),n._boundEvents=[],n},this.update=function(e,t){if(!n.el)return Promise.reject(new Error("View element not defined"));return(e?n.el.find(e):n.el).html(t),Promise.resolve(n)},this.show=function(e=!1){return n.el?e?n.el.animateAsync({opacity:1},300).then(()=>(n.el.show(),n)):(n.el.show(),Promise.resolve(n)):Promise.resolve(n)},this.hide=function(e=!1){return n.el?e?n.el.animateAsync({opacity:0},300).then(()=>(n.el.hide(),n)):(n.el.hide(),Promise.resolve(n)):Promise.resolve(n)},this.destroy=function(){return n.undelegateEvents(),n.el&&n.el.empty(),Promise.resolve()},this.el&&Object.keys(this.events).length>0&&this.delegateEvents(),this},l=function(e,t={}){const n=this;return this.$gui=e,this.options=t,this.model=t.model||null,this.view=t.view||null,this.routes=t.routes||{},this._bindings=[],this.initialize=function(){return Promise.resolve().then(()=>{if(n.model&&n.view)return n.bindModelToView()}).then(()=>{if("function"==typeof n.onInit)return n.onInit()}).then(()=>n)},this.bindModelToView=function(){if(!n.model||!n.view)return Promise.reject(new Error("Model and View required for binding"));const e=n.model.on("*",e=>{if(e.reset)return n.view.render(n.model.toJSON());"function"==typeof n.onModelChange?n.onModelChange(e):n.view.render(n.model.toJSON())});return n._bindings.push(e),Promise.resolve(n)},this.route=function(e,...t){const r=n.routes[e];if(!r)return Promise.reject(new Error(`No route handler for: ${e}`));const i="string"==typeof r?n[r]:r;return i?Promise.resolve(i.call(n,...t)):Promise.reject(new Error(`Route handler ${r} not found`))},this.updateFromForm=function(e){if(!n.model)return Promise.reject(new Error("Model not available"));const t=n.$GUI.$(e);if(!t.length)return Promise.reject(new Error(`Form not found: ${e}`));const r={};return t.serializeArray().forEach(({name:e,value:t})=>{r[e]=t}),n.model.update(r)},this.render=function(){if(!n.view)return Promise.reject(new Error("View not available"));const e=n.model?n.model.toJSON():{};return n.view.render(e)},this.destroy=function(){return n._bindings.forEach(e=>e()),n._bindings=[],n.view&&"function"==typeof n.view.destroy?n.view.destroy().then(()=>n):Promise.resolve(n)},this};var u={Model:a,View:c,Controller:l,createModel:e=>new a(e),createView:(e,t)=>new c(e,t),createController:(e,t)=>new l(e,t),MVCPlugin:function(e,t){const n={};return console.log("mvc gui =",e),n.load=function(e){return console.log("mvc sandbox = ",e),e.Model=t=>{const n=new a(t);return n.$GUI=e,n},e.View=t=>new c(e,t),e.Controller=t=>new l(e,t),e.createMVC=(t={})=>{const n=t.modelData?e.Model(t.modelData):null,r=t.viewOptions?e.View(t.viewOptions):null,i=e.Controller({model:n,view:r,routes:t.routes||{},...t.controllerOptions});return i.initialize().then(()=>({model:n,view:r,controller:i}))},Promise.resolve()},n}};const h=s.create("Metrics",function(e){const t=this;this.monitor=null,this.metricsInterval=null,this.$metricsDisplay=null;return this._updateMetricsDisplay=()=>{if(!this.$metricsDisplay||!this.monitor)return;const e=this.monitor.getMetrics(),t=`\n      <div class="metrics-panel">\n        <h3>Performance Metrics</h3>\n        <div class="metric-item">\n          <span class="label">Uptime:</span>\n          <span class="value">${this._formatUptime(e.uptime)}</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Total Routes:</span>\n          <span class="value">${e.totalRoutes}</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Total Modules:</span>\n          <span class="value">${e.totalModules}</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Avg Route Load:</span>\n          <span class="value">${e.averageRouteLoadTime}ms</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Avg Module Load:</span>\n          <span class="value">${e.averageModuleLoadTime}ms</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Cache Hit Rate:</span>\n          <span class="value">${e.cacheHitRate}%</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Cache Hits:</span>\n          <span class="value">${e.cacheHits}</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Cache Misses:</span>\n          <span class="value">${e.cacheMisses}</span>\n        </div>\n        <div class="metric-item">\n          <span class="label">Errors:</span>\n          <span class="value">${e.errors}</span>\n        </div>\n      </div>\n    `;this.$metricsDisplay.html(t)},this._formatUptime=e=>{const t=Math.floor(e/1e3),n=Math.floor(t/60),r=Math.floor(n/60);return r>0?`${r}h ${n%60}m`:n>0?`${n}m ${t%60}s`:`${t}s`},{load:function(n={}){return Promise.resolve().then(()=>{if(e.debug.log("Metrics module loading with options:",n),t.monitor=((t=!0)=>{const n={enabled:t,metrics:{routeLoadTimes:new Map,moduleLoadTimes:new Map,totalRoutes:0,totalModules:0,cacheHits:0,cacheMisses:0,errors:0,startTime:Date.now()},timings:new Map};return{startTiming:e=>{if(!n.enabled)return null;const t=performance.now();return n.timings.set(e,t),t},endTiming:e=>{if(!n.enabled||!n.timings.has(e))return 0;const t=n.timings.get(e),r=performance.now()-t;return e.startsWith("route:")?(n.metrics.routeLoadTimes.set(e,r),n.metrics.totalRoutes++):e.startsWith("module:")&&(n.metrics.moduleLoadTimes.set(e,r),n.metrics.totalModules++),n.timings.delete(e),r},recordCacheHit:()=>{n.enabled&&n.metrics.cacheHits++},recordCacheMiss:()=>{n.enabled&&n.metrics.cacheMisses++},recordError:t=>{n.enabled&&(n.metrics.errors++,e.log("Error recorded:",t))},getCacheHitRate:()=>{const e=n.metrics.cacheHits+n.metrics.cacheMisses;return e>0?(n.metrics.cacheHits/e*100).toFixed(2):0},getAverageLoadTime:e=>{const t="route"===e?n.metrics.routeLoadTimes:n.metrics.moduleLoadTimes;return 0===t.size?0:(Array.from(t.values()).reduce((e,t)=>e+t,0)/t.size).toFixed(2)},getMetrics:()=>({...n.metrics,routeLoadTimes:Array.from(n.metrics.routeLoadTimes.entries()),moduleLoadTimes:Array.from(n.metrics.moduleLoadTimes.entries()),uptime:Date.now()-n.metrics.startTime,cacheHitRate:n.metrics.cacheHits+n.metrics.cacheMisses>0?(n.metrics.cacheHits/(n.metrics.cacheHits+n.metrics.cacheMisses)*100).toFixed(2):0,averageRouteLoadTime:0===n.metrics.routeLoadTimes.size?0:(Array.from(n.metrics.routeLoadTimes.values()).reduce((e,t)=>e+t,0)/n.metrics.routeLoadTimes.size).toFixed(2),averageModuleLoadTime:0===n.metrics.moduleLoadTimes.size?0:(Array.from(n.metrics.moduleLoadTimes.values()).reduce((e,t)=>e+t,0)/n.metrics.moduleLoadTimes.size).toFixed(2)}),reset:()=>{n.metrics={routeLoadTimes:new Map,moduleLoadTimes:new Map,totalRoutes:0,totalModules:0,cacheHits:0,cacheMisses:0,errors:0,startTime:Date.now()},n.timings.clear()}}})(!1!==n.enabled),e.add("route:start",n=>{const r=`route:${n.path||"unknown"}`;t.monitor.startTiming(r),e.log("Route started:",r)}),e.add("route:complete",n=>{const r=`route:${n.path||"unknown"}`,i=t.monitor.endTiming(r);return e.log(`Route completed: ${r} in ${i}ms`),e.emit("metrics:updated",t.monitor.getMetrics())}),e.add("module:start",n=>{const r=`module:${n.name||"unknown"}`;t.monitor.startTiming(r),e.log("Module started:",r)}),e.add("module:complete",n=>{const r=`module:${n.name||"unknown"}`,i=t.monitor.endTiming(r);return e.log(`Module loaded: ${r} in ${i}ms`),e.emit("metrics:updated",t.monitor.getMetrics())}),e.add("cache:hit",()=>{t.monitor.recordCacheHit()}),e.add("cache:miss",()=>{t.monitor.recordCacheMiss()}),e.add("error",e=>{t.monitor.recordError(e)}),n.displayMetrics){t.$metricsDisplay=e.$("#metrics-display"),0===t.$metricsDisplay.length&&(t.$metricsDisplay=e.$('<div id="metrics-display"></div>'),e.$("body").append(t.$metricsDisplay));const r=n.updateInterval||5e3;t.metricsInterval=setInterval(()=>{t._updateMetricsDisplay()},r)}e.metrics={start:e=>t.monitor.startTiming(e),end:e=>t.monitor.endTiming(e),cacheHit:()=>t.monitor.recordCacheHit(),cacheMiss:()=>t.monitor.recordCacheMiss(),recordError:e=>t.monitor.recordError(e),get:()=>t.monitor.getMetrics(),reset:()=>t.monitor.reset()},e.log("Metrics module loaded successfully")})},unload:function(){return Promise.resolve().then(()=>{e.log("Metrics module unloading"),t.metricsInterval&&(clearInterval(t.metricsInterval),t.metricsInterval=null),t.$metricsDisplay&&(t.$metricsDisplay.remove(),t.$metricsDisplay=null),delete e.metrics})},destroy:function(){return Promise.resolve().then(()=>{e.log("Metrics module destroying"),t.monitor&&(t.monitor.reset(),t.monitor=null)})},getSnapshot:function(){return t.monitor?t.monitor.getMetrics():null},reset:function(){return Promise.resolve().then(()=>{if(t.monitor)return t.monitor.reset(),e.emit("metrics:reset")}).then(()=>{e.log("Metrics reset")})}}},{enabled:!0,displayMetrics:!1,updateInterval:5e3});s.use(u),s.use(function(e,t){return console.log("gui in router",fear),e.Router=o,{load:function(t){console.log("sandbox in plugin ",e),e.router=function(e){return new o(e)}}}}),$.FEAR=function(e){const t=e.instance?new i:e.instance;return e&&e.config&&t.configure(e.config),t.metrics=h,t},$.fear=$.FEAR({instance:s,config:{name:"GDREA - SPA"}}),window.FEAR=s});
